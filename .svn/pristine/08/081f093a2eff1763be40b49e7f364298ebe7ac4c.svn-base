set search_path to sandboxed_help_003;

/* DESTROY ALL */
delete from message;
delete from pattern;
delete from sequence;
delete from topic;
delete from umbrella;
delete from sequenceorder;
delete from patternorder;
delete from patternmessagetext;
delete from ivrmappingtable;
delete from patterntypetable;
delete from topicusersetup;
delete from UmbrellaTopicSetupTable;
/* DESTROY ALL */

with QT as (
select * from topic t --where topicid like '%TST%' order by topicid
),

QSO as (
select * from sequenceorder so where so.topic_sequenceorder_fk in (select _id_ from QT)
),

QS as (
select * from sequence s where s._id_ in (select sequence_sequenceorder_fk from QSO)
),

QPO as (
select * from patternorder po where po.sequence_patternorder_fk in (select _id_ from QS)
),

QP as (
select * from pattern p where p._id_ in (select pattern_patternorder_fk from QPO)
),

QMO as (
select * from patternmessagetext pmt where pmt.patternmessagetextid_pattern_fk in (select _id_ from QP)
),

QM as (
select * from message m where m._id_ in (select patternmessagetext_message_fk from QMO)
)

--select * from message where _id_ in (select _id_ from QM);
--select * from patternmessagetext where patternmessagetext_message_fk is null;
--select * from pattern where _id_ in (select _id_ from QP);
--select * from patternorder where pattern_patternorder_fk is null;
--select * from sequence where _id_ in (select _id_ from QS);
--select * from sequenceorder where sequence_sequenceorder_fk is null;
--select * from topic where _id_ in (select _id_ from QT);
--select * from ivrmappingtable where ivrmappingtable_pattern_fk is null;
--select * from patterntypetable where _id_ not in (select patterntypetable_pattern_fk from pattern);

/* ********************************************************** */
/* ********************************************************** */

/* ********************************************************** */

-- delete from message where _id_ in (select _id_ from QM);
-- delete from pattern where _id_ in (select _id_ from QP);
-- delete from sequence where _id_ in (select _id_ from QS);
-- delete from topic where _id_ in (select _id_ from QT);

delete from sequenceorder where sequence_sequenceorder_fk is null;
delete from patternorder where pattern_patternorder_fk is null;
delete from patternmessagetext where patternmessagetext_message_fk is null;
delete from ivrmappingtable where ivrmappingtable_pattern_fk is null;
delete from patterntypetable where _id_ not in (select patterntypetable_pattern_fk from pattern);
delete from topicusersetup where topic_topicusersetup_fk is null;

/* ********************************************************** */
/* ********************************************************** */

select topicid from topic order by topicid;
