unit MessageOrderEdit;

PatternMessageText messageOrder;
Pattern activity;
Message o_message;

int orderNumber;

string msg;
string nav_return;

bool isEdit;

void init() {

	if (nav_return == null){
		nav_return = "nav_message_order_management";
	}

	if (messageOrder == null){
		messageOrder = PatternMessageText:new();
		isEdit = false;
		orderNumber = null;
	} else {
		activity = messageOrder.patternMessageTextID_pattern;
		o_message = messageOrder.patternMessageText_Message;
		isEdit = true;
		orderNumber = messageOrder._MTID_order;
	}
}
 
void resetVars(){

	messageOrder = null;
	activity = null;
	o_message = null;
	msg = "";
	orderNumber = null;

}

string saveMessageOrderButton(){
	
	if (saveMessageOrder() != true){
		return null;
	}

	return back();
}

string saveMessageOrderAndCreateAnotherButton(){

	if (saveMessageOrder() != true){
		return null;
	}

	MessageEdit:activity = activity;

	nav_return = "nav_message_edit";

	return back();
}

bool saveMessageOrder() {

	if (activity == null){
		msg = "Please select an Activity";
   		Alerter:alert(msg);
   		return false;
	}	

	if (o_message == null){
		msg = "Please select a Message";
   		Alerter:alert(msg);
   		return false;
	}

	if (orderNumber == null){
		msg = "Please enter an OrderNumber";
   		Alerter:alert(msg);
   		return false;
	}

	if (orderNumber <= 0){
		msg = "Please enter an OrderNumber which is a positive integer";
   		Alerter:alert(msg);
   		return false;
	}

	bool b = MessageOrderController:isMessagewOrderAssignedToActivity(activity, orderNumber);
	if (b == true){

		if (isEdit == true){
			if (orderNumber != messageOrder._MTID_order){
				msg = String:concat("The MessageOrder number", orderNumber, " already exists, please enter a unique MessageOrder number");
   				Alerter:alert(msg);
   				return null;
			}
		} else {
			msg = String:concat("Activity ", activity.patternID, " already has the OrderNumber ", orderNumber, " please enter a unique MessageOrder number");
   			Alerter:alert(msg);
   			return null;
		}
	}

	int iMessageOrder = MessageOrderController:getMessageOrderForMessageActivity(o_message, activity);

	if (iMessageOrder != 0 && isEdit == false){
		msg = String:concat("The Message and Activity are already connected with Message Order Number: ", iMessageOrder);
		Alerter:alert(msg);
		return false;
	}

	messageOrder._MTID_order = orderNumber;
 	messageOrder.patternMessageTextID_pattern = activity;
 	messageOrder.patternMessageText_Message = o_message;
 	messageOrder.save();

 	msg = "Message Order Saved";
	Alerter:alert(msg);

	MessageOrderManagement:activityFilter = messageOrder.patternMessageTextID_pattern;
 	
 	nav_return = "nav_message_order_management";
 	
 	return true;
 }

string back(){
	resetVars();
	return nav_return;
}