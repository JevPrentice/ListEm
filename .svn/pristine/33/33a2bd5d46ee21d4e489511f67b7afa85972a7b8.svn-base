set search_path to sandboxed_help_003;

/*
	Based on the logic below:
	
	Line 1 (Total) = 
				Line 2 (Scheduled, not elsewhere Active) 
				+ Line 3 (Active) 
				+ Line 8 (Inactive, not elsewhere Active or Scheduled)

	Line 4 (Active + Scheduled) = 
				Line 2 
				+ Line 3
				
	Line 4 (Active + Scheduled) = 
				Line 5 (Active/Scheduled, not Searching) 
				+ Line 6 (Searching, Scheduled for another Topic) 
				+ Line 7 (Searching, Not scheduled for another Topic)

*/

-- User Stats Line 1
-- Simple count of all users
select '1. Total Users in System' as "User Stats", count (distinct c._id_) as "Count"
from client c

union all

-- User Stats Line 2
-- All unique Users in TopicUserSetup 
-- Where (Active = 2) (ie Scheduled)
--   where NOT also in 
-- All unique Users in TopicUserSetup 
-- Where (Active = 1) (ie Active)
select 	'2. Scheduled Users in System' as "User Stats", 
	count (distinct tus.client_topicusersetup_fk)
from topicusersetup tus
where tus.active = 2
	and tus.client_topicusersetup_fk not in
	(
		select tus.client_topicusersetup_fk
		from topicusersetup tus
		where active in (1)
	)

union all

-- User Stats Line 3
-- All unique Users in TopicUserSetup 
-- Where (Active = 1) (ie Active)
select 	'3. Active Users in System' as "User Stats", 
	count (distinct tus.client_topicusersetup_fk)
from topicusersetup tus
where tus.active = 1

union all

-- User Stats Line 4
-- All unique Users in TopicUserSetup 
-- Where (Active = 1 or 2) (ie Active or Scheduled)
select 	'4. Active and Scheduled Users in System' as "User Stats", 
	count (distinct tus.client_topicusersetup_fk)
from topicusersetup tus
where tus.active in (1,2)
	
union all

-- User Stats Line 5
-- All unique Users in TopicUserSetup 
-- Where (Active = 1 or 2) and Runtype != 40 (ie Not Searching)
select 	'5. Scheduled Topic in Progress' as "User Stats", 
	count (distinct tus.client_topicusersetup_fk)
from topicusersetup tus
where tus.active in (1,2) and tus.runtype != 40

union all

-- User Stats Line 6
-- All unique Users in TopicUserSetup 
-- Where (Active = 1 or 2) and Runtype = 40 (ie Searching)
--   where also in 
-- All unique Users in TopicUserSetup
-- Where (Active = 20) and Runtype != 40 (ie Paused, but not Searching)
select '6. Searching (Scheduled for another Topic)' as "User Stats",
	count (distinct tus.client_topicusersetup_fk)
from topicusersetup tus
where tus.active in (1,2) and tus.runtype = 40
and (tus.client_topicusersetup_fk in
	(select distinct tus.client_topicusersetup_fk
	from topicusersetup tus
	where tus.active = 20 and tus.runtype != 40))

union all

-- User Stats Line 7
-- All unique Users in TopicUserSetup 
-- Where (Active = 1 or 2) and Runtype = 40 (ie Searching)
--   where NOT also in 
-- All unique Users in TopicUserSetup
-- Where (Active = 20) and (Runtype != 40) (ie Paused, but not Searching)
select '7. Searching (Not Scheduled for another Topic)' as "User Stats",
	count (distinct tus.client_topicusersetup_fk)
from topicusersetup tus
where tus.active in (1,2) and tus.runtype = 40
and (tus.client_topicusersetup_fk not in
	(select distinct tus.client_topicusersetup_fk
	from topicusersetup tus
	where tus.active = 20 and tus.runtype != 40))

union all

-- User Stats Line 8
-- All unique Users in Users table
--   where also in 
-- All unique Users in TopicUserSetup 
-- Where (Active = 1 or 2) (ie Scheduled or Active)
select '8. Inactive Users in System' as "User Stats",
	count (distinct c._id_)
from client c
where c._id_ not in
(
	select tus.client_topicusersetup_fk
	from topicusersetup tus
	where active in (1,2)
)

;